<!DOCTYPE html>
<html>
<head>
<title>demos.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* Tomorrow Night Bright Theme */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
  color: #969896;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
  color: #d54e53;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
  color: #e78c45;
}

/* Tomorrow Yellow */
.hljs-attribute {
  color: #e7c547;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #b9ca4a;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
  color: #7aa6da;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
  color: #c397d8;
}

.hljs {
  display: block;
  overflow-x: auto;
  background: black;
  color: #eaeaea;
  padding: 0.5em;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

</style>
<link rel="stylesheet" href="file:///home/javi/Dropbox/ASIR/plantilla.css" type="text/css">
<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="carga-de-datos-a-la-aplicaci%C3%B3n">Carga de datos a la aplicación</h1>
<h2 id="api">API</h2>
<pre class="hljs"><code><div>git <span class="hljs-built_in">clone</span> https://github.com/netbox-community/Device-Type-Library-Import.git
<span class="hljs-built_in">cd</span> Device-Type-Library-Import
python3 -m venv venv
<span class="hljs-built_in">source</span> venv/bin/activate
</div></code></pre>
<pre class="hljs"><code><div>pip install -r requirements.txt
</div></code></pre>
<pre class="hljs"><code><div>cp .env.example .env
nano .env
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-attr">NETBOX_URL</span>=https://proyecto.javihuete.site
<span class="hljs-attr">NETBOX_TOKEN</span>=<span class="hljs-number">17578</span>e115ef0e83cd0598b12b74fc6da3bc97f18
<span class="hljs-attr">REPO_URL</span>=https://github.com/netbox-community/devicetype-library.git
<span class="hljs-attr">REPO_BRANCH</span>=master
<span class="hljs-attr">IGNORE_SSL_ERRORS</span>=<span class="hljs-literal">False</span>
<span class="hljs-comment">#REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt # you should enable this&gt;</span>
<span class="hljs-comment">#SLUGS=c9300-48u isr4431 isr4331</span>
</div></code></pre>
<pre class="hljs"><code><div>./nb-dt-import.py --vendors hpe
</div></code></pre>
<hr>
<pre class="hljs"><code><div>curl -X <span class="hljs-string">'POST'</span> \
  <span class="hljs-string">'https://proyecto.javihuete.site/api/dcim/devices/'</span> \
  -H <span class="hljs-string">'accept: application/json'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -H <span class="hljs-string">'X-CSRFTOKEN: faYlf7DEOeMNPBH7PshVHS6vBj58naklpAvSjwe1PrpdN33AHJhwAMnXxM3pY8zm'</span> \
  -d <span class="hljs-string">'{
  "name": "string",
  "device_type": 0,
  "role": 0,
  "tenant": 0,
  "platform": 0,
  "serial": "string",
  "asset_tag": "string",
  "site": 0,
  "location": 0,
  "rack": 0,
  "position": 999,
  "face": "front",
  "latitude": 99,
  "longitude": 999,
  "status": "offline",
  "airflow": "front-to-rear",
  "primary_ip4": 0,
  "primary_ip6": 0,
  "oob_ip": 0,
  "cluster": 0,
  "virtual_chassis": 0,
  "vc_position": 255,
  "vc_priority": 255,
  "description": "string",
  "comments": "string",
  "config_template": 0,
  "local_context_data": "string",
  "tags": [
    {
      "name": "string",
      "slug": "Rg95D1Bn0FS_xFenhX-qYt1mnekoznwj85brCHMsFTowpXUU4VK3NCOgkBR9d-3ftTtWnUQKIUR7_nt9N31G-q2NeTcmoFk",
      "color": "ba8f1f"
    }
  ],
  "custom_fields": {
    "additionalProp1": "string",
    "additionalProp2": "string",
    "additionalProp3": "string"
  }
}'</span>
</div></code></pre>
<hr>
<h2 id="ansible">Ansible</h2>
<pre class="hljs"><code><div><span class="hljs-meta">---</span>
<span class="hljs-attr">ip_addresses:</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Victini</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">GigabitEthernet1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Reshiram</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Zekrom</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Keldeo</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.4</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Reshiram</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">172.22</span><span class="hljs-number">.100</span><span class="hljs-number">.16</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Reserved</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-meta">---</span>
<span class="hljs-attr">ip_addresses:</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Victini</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">GigabitEthernet1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Reshiram</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Zekrom</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.3</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Keldeo</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.4</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">assigned_object:</span>
      <span class="hljs-attr">device:</span> <span class="hljs-string">Reshiram</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">Gig-E</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">address:</span> <span class="hljs-number">172.22</span><span class="hljs-number">.100</span><span class="hljs-number">.16</span><span class="hljs-string">/25</span>
    <span class="hljs-attr">status:</span> <span class="hljs-string">Active</span>
</div></code></pre>
<h1 id="configuraci%C3%B3n-de-caddy-a-trav%C3%A9s-de-la-api">Configuración de Caddy a través de la API</h1>
<h2 id="ver-la-configuraci%C3%B3n-actual">Ver la configuración actual</h2>
<pre class="hljs"><code><div>curl localhost:2019/config/ | jq
</div></code></pre>
<h2 id="modificar-la-configuraci%C3%B3n">Modificar la configuración</h2>
<h3 id="modificar-la-ip-del-backend">Modificar la IP del backend</h3>
<h4 id="agregar-configuraci%C3%B3n-desde-un-fichero-json">Agregar configuración desde un fichero JSON</h4>
<pre class="hljs"><code><div>cat caddyconfig.json
</div></code></pre>
<pre class="hljs"><code><div>curl localhost:2019/load \
	-H <span class="hljs-string">"Content-Type: application/json"</span> \
	-d @caddyconfig.json
</div></code></pre>
<h4 id="ver-s%C3%B3lo-la-direcci%C3%B3n-ip-de-un-backend">Ver sólo la dirección IP de un backend</h4>
<pre class="hljs"><code><div>curl localhost:2019/config/apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/ | jq

curl localhost:2019/config/apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/0/dial/

curl localhost:2019/config/apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/1/dial/
</div></code></pre>
<h4 id="modificar-s%C3%B3lo-la-direcci%C3%B3n-ip-de-un-backend">Modificar sólo la dirección IP de un backend</h4>
<pre class="hljs"><code><div>curl \
	localhost:2019/config/apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/1/dial/ \
	-H <span class="hljs-string">"Content-Type: application/json"</span> \
	-d <span class="hljs-string">'"172.22.201.219:80"'</span>
</div></code></pre>
<h4 id="crear-un-id-para-acceder-directamente-a-esta-configuraci%C3%B3n">Crear un ID para acceder directamente a esta configuración</h4>
<pre class="hljs"><code><div>curl \
	localhost:2019/config/apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/@id \
	-H <span class="hljs-string">"Content-Type: application/json"</span> \
	-d <span class="hljs-string">'"ip"'</span>

curl localhost:2019/config/apps/http/servers/srv0/routes/0/handle/0/routes/0/handle/0/upstreams/
</div></code></pre>
<h4 id="modificar-la-ip-de-un-backend-usando-el-id">Modificar la IP de un backend usando el ID</h4>
<pre class="hljs"><code><div>curl \
	localhost:2019/id/ip/1/dial/ \
	-H <span class="hljs-string">"Content-Type: application/json"</span> \
	-d <span class="hljs-string">'"172.22.200.202:80"'</span>
</div></code></pre>
<h4 id="ver-los-cambios">Ver los cambios</h4>
<pre class="hljs"><code><div>curl localhost:2019/id/ip/
</div></code></pre>
<h3 id="ventajas-del-uso-de-la-api-automatizar-los-cambios-en-la-configuraci%C3%B3n">Ventajas del uso de la API: automatizar los cambios en la configuración</h3>
<pre class="hljs"><code><div>bash lb_policy.sh random
</div></code></pre>
<h2 id="funcionamiento-del-health-check">Funcionamiento del health check</h2>
<h3 id="ver-el-estado-de-salud-de-los-backends">Ver el estado de salud de los backends</h3>
<pre class="hljs"><code><div>curl <span class="hljs-string">"localhost:2019/metrics"</span> | grep caddy_reverse_proxy_upstreams_healthy
</div></code></pre>
<h3 id="revisar-el-estado-de-salud-de-los-backends-con-un-script">Revisar el estado de salud de los backends con un script</h3>
<pre class="hljs"><code><div>bash salud.sh
</div></code></pre>

</body>
</html>
